// QA Studio - Test Reporting Platform Schema
// Inspired by Allure TestOps and TestRail

generator client {
  provider = "prisma-client-js"
  // output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & TEAMS
// ============================================

model User {
  id            String   @id // Clerk user ID
  email         String   @unique
  firstName     String?
  lastName      String?
  imageUrl      String?
  role          UserRole @default(TESTER)

  // Team membership
  teamId        String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  team          Team?     @relation(fields: [teamId], references: [id], onDelete: SetNull)
  createdProjects  Project[]  @relation("ProjectCreator")
  createdTestCases TestCase[] @relation("TestCaseCreator")
  createdTestRuns  TestRun[]  @relation("TestRunCreator")
  executedResults  TestResult[] @relation("TestResultExecutor")
  apiKeys       ApiKey[]

  @@index([email])
  @@index([teamId])
  @@index([role])
}

model ApiKey {
  id          String   @id @default(cuid())
  name        String   // User-friendly name like "CI/CD Pipeline"
  key         String   @unique // The actual API key (hashed)
  prefix      String   // First 8 chars for display (e.g., "qas_1234...")
  userId      String
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@index([prefix])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members      User[]
  projects     Project[]
  subscription Subscription?
  integrations Integration[]

  @@index([name])
}

model Subscription {
  id                   String             @id @default(cuid())
  teamId               String             @unique
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(TRIALING)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  seats                Int                @default(1)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

enum SubscriptionStatus {
  TRIALING      // Free trial period
  ACTIVE        // Paid and active
  PAST_DUE      // Payment failed
  CANCELED      // Subscription canceled
  INCOMPLETE    // Initial payment pending
  INCOMPLETE_EXPIRED // Initial payment failed
  UNPAID        // Payment failed, subscription ended
}

enum UserRole {
  ADMIN      // Full system access
  MANAGER    // Can manage projects and teams
  TESTER     // Can create and execute tests
  VIEWER     // Read-only access
}

// ============================================
// PROJECTS & ORGANIZATION
// ============================================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  key         String   @unique // Short identifier like "PROJ"
  createdBy   String   // Clerk user ID
  teamId      String?  // Optional team ownership
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User     @relation("ProjectCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  testSuites  TestSuite[]
  testCases   TestCase[]
  testRuns    TestRun[]
  milestones  Milestone[]
  environments Environment[]

  @@index([createdBy])
  @@index([teamId])
}

model Milestone {
  id          String   @id @default(cuid())
  name        String
  description String?
  dueDate     DateTime?
  status      MilestoneStatus @default(ACTIVE)
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testRuns    TestRun[]

  @@index([projectId])
}

enum MilestoneStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

model Environment {
  id          String   @id @default(cuid())
  name        String   // e.g., "Production", "Staging", "QA"
  description String?
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testRuns    TestRun[]

  @@index([projectId])
  @@unique([projectId, name])
}

// ============================================
// TEST SUITES & CASES
// ============================================

model TestSuite {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String
  parentId    String?  // For nested suites
  order       Int      @default(0) // For drag-and-drop ordering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent      TestSuite?  @relation("SuiteHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    TestSuite[] @relation("SuiteHierarchy")
  testCases   TestCase[]

  @@index([projectId])
  @@index([parentId])
}

model TestCase {
  id            String   @id @default(cuid())
  title         String
  description   String?
  preconditions String?  // Setup requirements
  steps         Json?    // Array of test steps
  expectedResult String?
  priority      Priority @default(MEDIUM)
  type          TestType @default(FUNCTIONAL)
  automationStatus AutomationStatus @default(NOT_AUTOMATED)
  tags          String[] // For categorization
  projectId     String
  suiteId       String?
  createdBy     String   // Clerk user ID
  order         Int      @default(0) // For drag-and-drop ordering
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  creator       User      @relation("TestCaseCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  suite         TestSuite? @relation(fields: [suiteId], references: [id], onDelete: SetNull)
  results       TestResult[]
  attachments   Attachment[]

  @@index([projectId])
  @@index([suiteId])
  @@index([priority])
  @@index([type])
  @@index([createdBy])
  @@index([order])
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum TestType {
  FUNCTIONAL
  REGRESSION
  SMOKE
  INTEGRATION
  PERFORMANCE
  SECURITY
  UI
  API
  UNIT
  E2E
}

enum AutomationStatus {
  AUTOMATED
  NOT_AUTOMATED
  CANDIDATE
}

// ============================================
// TEST RUNS & RESULTS
// ============================================

model TestRun {
  id            String   @id @default(cuid())
  name          String
  description   String?
  projectId     String
  milestoneId   String?
  environmentId String?
  status        RunStatus @default(PLANNED)
  createdBy     String   // Clerk user ID
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  creator       User         @relation("TestRunCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone     Milestone?   @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: SetNull)
  results       TestResult[]

  @@index([projectId])
  @@index([milestoneId])
  @@index([environmentId])
  @@index([status])
  @@index([createdBy])
}

enum RunStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  ABORTED
}

model TestResult {
  id          String   @id @default(cuid())
  testCaseId  String
  testRunId   String
  status      TestStatus
  comment     String?  // Tester notes
  duration    Int?     // Duration in milliseconds
  stackTrace  String?  // For failures
  errorMessage String? // For failures
  executedBy  String   // Clerk user ID
  executedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  executor    User       @relation("TestResultExecutor", fields: [executedBy], references: [id], onDelete: Cascade)
  testCase    TestCase   @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  testRun     TestRun    @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  attachments Attachment[]
  steps       TestStepResult[]

  @@index([testCaseId])
  @@index([testRunId])
  @@index([status])
  @@index([executedAt])
  @@index([executedBy])
}

enum TestStatus {
  PASSED
  FAILED
  BLOCKED
  SKIPPED
  RETEST
  UNTESTED
}

model TestStepResult {
  id           String   @id @default(cuid())
  testResultId String
  stepNumber   Int
  description  String
  status       TestStatus
  comment      String?
  createdAt    DateTime @default(now())

  testResult   TestResult @relation(fields: [testResultId], references: [id], onDelete: Cascade)

  @@index([testResultId])
}

// ============================================
// ATTACHMENTS & MEDIA
// ============================================

model Attachment {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int      // Size in bytes
  url          String   // Storage location (S3, local, etc.)
  testCaseId   String?
  testResultId String?
  createdAt    DateTime @default(now())

  testCase     TestCase?   @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  testResult   TestResult? @relation(fields: [testResultId], references: [id], onDelete: Cascade)

  @@index([testCaseId])
  @@index([testResultId])
}

// ============================================
// INTEGRATIONS
// ============================================

model Integration {
  id              String            @id @default(cuid())
  teamId          String
  type            IntegrationType
  name            String            // User-friendly name like "Engineering Slack"
  status          IntegrationStatus @default(ACTIVE)

  // OAuth & Connection Data (encrypted in production)
  accessToken     String?           // OAuth access token
  refreshToken    String?           // OAuth refresh token
  tokenExpiresAt  DateTime?
  webhookUrl      String?           // For incoming webhooks
  webhookSecret   String?           // For verifying webhook signatures

  // Integration-specific configuration (JSON)
  config          Json?             // Channel IDs, preferences, etc.

  // Metadata
  installedBy     String            // User ID who installed
  lastSyncedAt    DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  team            Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  notifications   IntegrationNotification[]

  @@index([teamId])
  @@index([type])
  @@index([status])
}

enum IntegrationType {
  SLACK
  DISCORD
  TEAMS
  JIRA
  GITHUB
  GITLAB
  WEBHOOK
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
}

model IntegrationNotification {
  id            String           @id @default(cuid())
  integrationId String
  eventType     NotificationEvent
  status        NotificationStatus @default(PENDING)
  payload       Json              // Event data to send
  response      Json?             // Response from integration
  error         String?
  attempts      Int               @default(0)
  maxAttempts   Int               @default(3)
  nextRetryAt   DateTime?
  sentAt        DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  integration   Integration       @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetryAt])
}

enum NotificationEvent {
  TEST_RUN_STARTED
  TEST_RUN_COMPLETED
  TEST_RUN_FAILED
  TEST_CASE_FAILED
  TEST_CASE_PASSED
  MILESTONE_DUE
  PROJECT_CREATED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  RETRYING
}
